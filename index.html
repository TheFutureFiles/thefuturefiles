<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Future Files</title>
    <link rel="icon" href="thefuturefiles.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gmailRed: '#ea4335',
                        gmailGray: '#f2f2f2',
                        gmailDark: '#131314',
                        searchBarDark: '#1e1f20',
                        gmailRowHover: '#f5f5f5',
                        darkRowHover: '#303134',
                        spotifyBlack: '#000000',
                        spotifyDark: '#121212',
                        spotifyGray: '#282828',
                        spotifyLightGray: '#b3b3b3'
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }

        /* CLEAN RAINBOW ANIMATION */
        @keyframes colorCycle {
            0% {
                color: #ff0000;
            }

            15% {
                color: #ff7f00;
            }

            30% {
                color: #ffff00;
            }

            45% {
                color: #00ff00;
            }

            60% {
                color: #0000ff;
            }

            75% {
                color: #4b0082;
            }

            90% {
                color: #9400d3;
            }

            100% {
                color: #ff0000;
            }
        }

        .rainbow-glow {
            animation: colorCycle 6s linear infinite;
            font-weight: 900;
        }

        /* Visualizer - 4 bars, equal width */
        .visualizer {
            display: flex;
            align-items: flex-end;
            height: 16px;
            width: 16px;
            gap: 2px;
        }

        .bar {
            flex: 1;
            background-color: #f97316;
            /* Orange */
            animation: equalize 1s infinite;
        }

        @keyframes equalize {
            0% {
                height: 20%;
            }

            50% {
                height: 100%;
            }

            100% {
                height: 20%;
            }
        }

        .bar:nth-child(1) {
            animation-delay: 0.1s;
        }

        .bar:nth-child(2) {
            animation-delay: 0.3s;
        }

        .bar:nth-child(3) {
            animation-delay: 0.0s;
        }

        .bar:nth-child(4) {
            animation-delay: 0.2s;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 6px;
            border: 3px solid #fff;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #5f6368;
            border-color: #202124;
        }

        /* Filter Chips */
        .filter-chip {
            background-color: #282828;
            /* Dark Gray */
            color: #fff;
            padding: 8px 16px;
            border-radius: 9999px;
            /* Fully rounded */
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .filter-chip:hover {
            background-color: #3E3E3E;
        }

        .active-chip {
            background-color: #ffffff !important;
            color: #000000 !important;
            border-color: #ffffff;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Play Button Hover Logic */
        .play-btn-group .play-icon {
            display: none;
        }

        .play-btn-group .index-num {
            display: block;
        }

        .play-btn-group:hover .play-icon {
            display: block;
        }

        .play-btn-group:hover .index-num {
            display: none;
        }

        /* Playing State Logic */
        .playing-row .play-btn-group .index-num {
            display: none;
        }

        .playing-row .play-btn-group .play-icon {
            display: none;
        }

        .playing-row .play-btn-group .visualizer {
            display: flex;
        }

        /* Paused State Logic within Playing Row */
        .playing-row.paused .play-btn-group .visualizer {
            display: none;
        }

        .playing-row.paused .play-btn-group .index-num {
            display: block;
        }

        /* Hover on Playing Row */
        .playing-row .play-btn-group:hover .visualizer {
            display: none;
        }

        .playing-row .play-btn-group:hover .index-num {
            display: none;
        }

        .playing-row .play-btn-group:hover .pause-icon {
            display: block;
        }

        .playing-row.paused .play-btn-group:hover .pause-icon {
            display: none;
        }

        .playing-row.paused .play-btn-group:hover .play-icon {
            display: block;
        }

        .pause-icon {
            display: none;
        }

        /* Range Input Styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            margin-top: -4px;
            display: none;
        }

        input[type=range]:hover::-webkit-slider-thumb {
            display: block;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4d4d4d;
            border-radius: 2px;
        }

        .overlay-lyrics {
            background: linear-gradient(180deg, #2a3e2a 0%, #121212 100%);
        }
    </style>
</head>

<body
    class="bg-white dark:bg-gmailDark text-gray-800 dark:text-gray-200 h-screen flex flex-col overflow-hidden transition-colors duration-200">

    <header
        class="h-16 flex items-center justify-between px-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gmailDark shrink-0 z-50">
        <div class="flex items-center flex-1">
            <div class="flex items-center w-64 flex-shrink-0 pl-4">
                <button class="p-3 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 mr-4">
                    <i class="fas fa-bars text-xl text-gray-600 dark:text-gray-400"></i>
                </button>

                <div class="flex items-center mr-8">
                    <img src="thefuturefiles.jpg" class="h-10 w-10 object-cover rounded-[14px] mr-3 shadow-sm">
                </div>
            </div>

            <div
                class="bg-gray-100 dark:bg-searchBarDark rounded-3xl flex items-center px-4 py-2 max-w-2xl w-full mx-2 focus-within:bg-white dark:focus-within:bg-gray-600 focus-within:shadow-md transition-all shadow-sm">
                <i class="fas fa-search text-gray-500 dark:text-gray-400 mr-3"></i>
                <input type="text" id="searchInput" placeholder='Search transcripts...'
                    class="bg-transparent border-none outline-none w-full text-base dark:text-white dark:placeholder-gray-400"
                    oninput="handleInputSearch()">
            </div>
        </div>

        <div class="flex justify-end items-center w-32 space-x-2">
            <button onclick="toggleTheme()"
                class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                <i id="themeIcon" class="fas fa-sun text-yellow-400 text-lg"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <aside
            class="w-64 flex flex-col pt-4 pr-2 hidden md:flex hover:overflow-y-auto shrink-0 bg-white dark:bg-gmailDark">
            <button
                class="ml-4 mb-6 bg-white dark:bg-gray-800 text-gray-800 dark:text-white border dark:border-gray-600 hover:shadow-lg transition px-6 py-4 rounded-2xl shadow-sm flex items-center w-48">
                <i class="fas fa-server text-orange-500 mr-3 text-xl"></i><span class="font-medium">Host the
                    Files</span>
            </button>
            <div class="space-y-1">
                <div onclick="setView('episodes')" id="nav-episodes"
                    class="bg-orange-100 dark:bg-orange-900/50 text-orange-800 dark:text-orange-300 font-bold px-6 py-2 rounded-r-full cursor-pointer flex items-center border-l-4 border-orange-500 transition-colors">
                    <i class="fas fa-inbox w-5 mr-4"></i> All Episodes
                </div>
                <div onclick="setView('marketplace')" id="nav-marketplace"
                    class="px-6 py-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-r-full cursor-pointer flex items-center text-gray-700 dark:text-gray-400 mt-2 border-l-4 border-transparent transition-colors">
                    <i class="fas fa-store w-5 mr-4 text-green-500"></i> Marketplace
                </div>
                <div onclick="toggleCompose()"
                    class="px-6 py-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-r-full cursor-pointer flex items-center text-gray-700 dark:text-gray-400 mt-2 border-l-4 border-transparent transition-colors">
                    <i class="fas fa-paper-plane w-5 mr-4 text-blue-500"></i> Mail Me!
                </div>
            </div>
        </aside>

        <main class="flex-1 bg-white dark:bg-gmailDark overflow-y-auto relative scroll-smooth" id="mainContainer"
            onscroll="handleScroll()">

            <!-- Microphone Overlay -->
            <div id="micOverlay" class="hidden absolute inset-0 z-40 overlay-lyrics p-8 overflow-y-auto">
                <div class="max-w-4xl mx-auto mt-10">
                    <h2 id="overlayTitle" class="text-4xl font-bold text-white mb-8"></h2>
                    <div id="overlayText" class="text-2xl font-bold text-white/80 leading-relaxed space-y-6"></div>
                </div>
            </div>

            <!-- Play/Shuffle Header -->
            <div class="px-4 pt-6 pb-2 bg-white dark:bg-gmailDark flex items-center space-x-4">
                <button onclick="playHeaderBtn()"
                    class="w-14 h-14 rounded-full bg-orange-500 hover:bg-orange-600 flex items-center justify-center shadow-lg transition transform hover:scale-105">
                    <i class="fas fa-play text-white text-2xl ml-1"></i>
                </button>
                <button onclick="toggleShuffle()" id="shuffleBtn"
                    class="text-gray-400 hover:text-orange-500 transition text-2xl p-2">
                    <i class="fas fa-random"></i>
                </button>
            </div>

            <!-- Horizontal Filter Bar -->
            <div
                class="px-4 py-2 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between bg-white dark:bg-gmailDark sticky top-0 z-10 overflow-x-auto no-scrollbar">
                <div class="flex space-x-2 items-center" id="filterBar">
                    <button onclick="setFilter('any')" id="btn-any"
                        class="filter-chip active-chip whitespace-nowrap">All</button>
                    <button onclick="setFilter('2022')" id="btn-2022"
                        class="filter-chip whitespace-nowrap">2022</button>
                    <button onclick="setFilter('2021')" id="btn-2021"
                        class="filter-chip whitespace-nowrap">2021</button>
                    <button onclick="setFilter('2020')" id="btn-2020"
                        class="filter-chip whitespace-nowrap">2020</button>
                    <button onclick="setFilter('2019')" id="btn-2019"
                        class="filter-chip whitespace-nowrap">2019</button>
                    <button onclick="setFilter('2018')" id="btn-2018"
                        class="filter-chip whitespace-nowrap">2018</button>
                    <button onclick="setFilter('2017')" id="btn-2017"
                        class="filter-chip whitespace-nowrap">2017</button>
                    <button onclick="setFilter('2016')" id="btn-2016"
                        class="filter-chip whitespace-nowrap">2016</button>
                    <button onclick="openCustomRange()" id="btn-custom"
                        class="filter-chip whitespace-nowrap">Custom</button>
                </div>
                <span id="resultCount" class="text-xs text-gray-400 ml-4 whitespace-nowrap">Loading...</span>
            </div>

            <!-- Spinning Loader -->
            <div id="initialLoader" class="flex justify-center items-center py-20">
                <img src="thefuturefiles.jpg" class="w-16 h-16 rounded-full animate-spin">
            </div>

            <div id="episodeList" class="pb-24 hidden"></div>
            <div id="marketplaceList" class="hidden pb-24"></div>

            <button onclick="scrollToTop()" id="backToTopBtn"
                class="fixed bottom-24 right-8 bg-gray-600 hover:bg-gray-800 text-white w-12 h-12 rounded-lg shadow-lg flex items-center justify-center transition-transform transform translate-y-32 z-40">
                <i class="fas fa-arrow-up"></i>
            </button>
        </main>
    </div>

    <!-- Spotify Style Footer -->
    <footer
        class="h-24 bg-black border-t border-gray-800 flex items-center px-4 justify-between z-50 shrink-0 shadow-lg text-white">
        <!-- Left: Info -->
        <div class="flex items-center w-1/4 min-w-[200px]">
            <div
                class="h-14 w-14 bg-gray-800 rounded flex items-center justify-center overflow-hidden mr-4 relative group">
                <img id="playerImg" src="thefuturefiles.jpg" class="w-full h-full object-cover hidden">
                <div id="playerPlaceholder" class="text-xs text-gray-400">TF</div>
            </div>
            <div class="overflow-hidden">
                <div id="playerTitle" class="font-bold text-sm truncate hover:underline cursor-pointer">Select an
                    episode</div>
                <div id="playerDate" class="text-xs text-gray-400 hover:underline cursor-pointer">The Future Files</div>
            </div>
        </div>

        <div class="flex-1 flex justify-center px-4 items-center space-x-4">
            <button onclick="playPrev()" class="text-gray-400 hover:text-white transition">
                <i class="fas fa-step-backward text-xl"></i>
            </button>
            <audio id="audioElement" controls class="w-full max-w-3xl h-10"></audio>
            <button onclick="playNext()" class="text-gray-400 hover:text-white transition">
                <i class="fas fa-step-forward text-xl"></i>
            </button>
        </div>
    </footer>

    <div id="composeModal"
        class="fixed bottom-0 right-20 w-[500px] bg-white dark:bg-gray-800 rounded-t-lg shadow-2xl z-[60] hidden border border-gray-300 dark:border-gray-600 transform translate-y-full transition-transform duration-300 compose-box">
        <div class="bg-gray-900 text-white px-4 py-2 rounded-t-lg flex justify-between items-center cursor-pointer"
            onclick="toggleCompose()">
            <span class="font-bold text-sm">New Message</span>
            <div class="flex space-x-3"><i class="fas fa-times hover:text-gray-300"></i></div>
        </div>
        <div class="p-6 h-96 flex flex-col items-center justify-center bg-gray-50 dark:bg-gray-900">
            <i class="fas fa-paper-plane text-6xl text-blue-500 mb-6"></i>
            <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Send me mail!</h2>
            <div
                class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 p-6 rounded text-center shadow-sm w-full">
                <p class="text-gray-600 dark:text-gray-300 font-bold">P.O. Box 29012</p>
                <p class="text-gray-600 dark:text-gray-300">Los Angeles, CA 90029</p>
            </div>
        </div>
    </div>

    <div id="customRangeModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-[70] hidden flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-80">
            <h3 class="font-bold text-lg mb-4 text-gray-800 dark:text-white">Custom Date Range</h3>
            <label class="block text-xs text-gray-500 mb-1">Start Date</label>
            <input type="date" id="startDate"
                class="w-full mb-3 p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <label class="block text-xs text-gray-500 mb-1">End Date</label>
            <input type="date" id="endDate"
                class="w-full mb-6 p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <div class="flex justify-end space-x-2">
                <button onclick="closeCustomRange()"
                    class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                <button onclick="applyCustomRange()"
                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Apply</button>
            </div>
        </div>
    </div>

    <script src="data_part0.js"></script>
    <script src="data_part1.js"></script>
    <script src="data_part2.js"></script>
    <script src="data_part3.js"></script>
    <script src="data_part4.js"></script>
    <script src="data_part5.js"></script>
    <script src="data_part6.js"></script>

    <script>
        let currentPlayingUid = null;
        let activeFilter = 'any';
        let customStart = null;
        let customEnd = null;
        let openDropdownUids = new Set();
        let currentView = 'episodes';
        let isShuffleOn = false;
        let currentFilteredData = [];

        const player = document.getElementById('audioElement');

        function formatDateWithSlashes(dateStr) {
            if (!dateStr || dateStr.length < 8) return dateStr;
            return `${dateStr.substring(0, 4)}/${dateStr.substring(4, 6)}/${dateStr.substring(6, 8)}`;
        }
        function formatTimestamp(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `[${h}:${m}:${s}]`;
        }
        function formatTimeSimple(seconds) {
            if (isNaN(seconds)) return "0:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                icon.className = "fas fa-moon text-gray-600 text-lg";
            } else {
                html.classList.add('dark');
                icon.className = "fas fa-sun text-yellow-400 text-lg";
            }
        }

        function handleScroll() {
            const container = document.getElementById('mainContainer');
            const btn = document.getElementById('backToTopBtn');
            if (container.scrollTop > 300) btn.classList.remove('translate-y-32');
            else btn.classList.add('translate-y-32');
        }
        function scrollToTop() { document.getElementById('mainContainer').scrollTo({ top: 0, behavior: 'smooth' }); }

        // --- Filter Logic ---
        function setFilter(val) {
            activeFilter = val; customStart = null; customEnd = null;
            updateFilterUI(val);
            runFilters();
        }

        function updateFilterUI(val) {
            // Reset all chips
            document.querySelectorAll('.filter-chip').forEach(el => {
                el.classList.remove('active-chip');
                if (el.id === 'btn-custom') el.innerText = "Custom";
            });

            // Activate selected
            if (val === 'custom') {
                const btn = document.getElementById('btn-custom');
                btn.classList.add('active-chip');
                if (customStart && customEnd) {
                    btn.innerText = `${formatDateWithSlashes(customStart)} - ${formatDateWithSlashes(customEnd)}`;
                }
            } else {
                const btn = document.getElementById(`btn-${val}`);
                if (btn) btn.classList.add('active-chip');
            }
        }

        function openCustomRange() { document.getElementById('customRangeModal').classList.remove('hidden'); }
        function closeCustomRange() { document.getElementById('customRangeModal').classList.add('hidden'); }
        function applyCustomRange() {
            const s = document.getElementById('startDate').value;
            const e = document.getElementById('endDate').value;
            if (s && e) {
                activeFilter = 'custom'; customStart = s.replace(/-/g, ''); customEnd = e.replace(/-/g, '');
                updateFilterUI("custom"); closeCustomRange(); runFilters();
            } else alert("Please select both dates.");
        }

        function runFilters() {
            if (!window.db) return;
            const query = document.getElementById('searchInput').value;
            let data = window.db;

            if (activeFilter !== 'any') {
                if (activeFilter === 'custom') data = data.filter(ep => ep.date >= customStart && ep.date <= customEnd);
                else data = data.filter(ep => ep.date.startsWith(activeFilter));
            }

            if (query && query.trim().length >= 3) {
                const rawTerms = query.split('+');
                const terms = rawTerms.map(t => t.trim().replace(/~/g, ' ').toLowerCase()).filter(t => t.length >= 1);
                if (terms.length > 0) {
                    data = data.filter(ep => {
                        const titleLower = (ep.title || "").toLowerCase();
                        const textLower = (ep.search_text || "").toLowerCase();
                        return terms.every(term => titleLower.includes(term) || textLower.includes(term));
                    });
                    currentFilteredData = data;
                    renderEpisodes(data, terms);
                    return;
                }
            } else if (query && query.trim().length > 0 && query.trim().length < 3) {
                return;
            }
            currentFilteredData = data;
            renderEpisodes(data);
        }

        const list = document.getElementById('episodeList');
        const countLabel = document.getElementById('resultCount');

        function renderEpisodes(data, searchTerms = []) {
            list.innerHTML = "";
            countLabel.innerText = `${data.length} episodes`;

            // Hide loader, show list
            document.getElementById('initialLoader').classList.add('hidden');
            document.getElementById('episodeList').classList.remove('hidden');

            data.forEach((ep, index) => {
                const uid = ep._uid !== undefined ? ep._uid : index;
                const row = document.createElement('div');
                row.className = "border-b border-gray-100 dark:border-gray-700 transition relative group";
                row.id = `row-${uid}`;

                if (currentPlayingUid === uid) {
                    row.classList.add('playing-row', 'bg-orange-50', 'dark:bg-gray-800');
                    if (player.paused) row.classList.add('paused');
                }

                const displayDate = formatDateWithSlashes(ep.date || "");
                let snippet = "";
                let displayTitle = ep.title;
                const isSearching = searchTerms.length > 0;

                if (isSearching) {
                    const primaryTerm = searchTerms[0];
                    const fullText = ep.search_text || "";
                    const matchIndex = fullText.indexOf(primaryTerm);
                    if (matchIndex !== -1) {
                        let startIdx = Math.max(0, matchIndex - 150);
                        if (startIdx > 0) {
                            const nextSpace = fullText.indexOf(' ', startIdx);
                            if (nextSpace !== -1) startIdx = nextSpace + 1;
                        }
                        const endIdx = Math.min(fullText.length, matchIndex + 600);
                        snippet = fullText.substring(startIdx, endIdx) + "...";
                        searchTerms.forEach(term => {
                            const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                            snippet = snippet.replace(regex, '<span class="rainbow-glow">$1</span>');
                            displayTitle = displayTitle.replace(regex, '<span class="rainbow-glow">$1</span>');
                        });
                    } else { snippet = fullText.substring(0, 300) + "..."; }
                } else {
                    if (ep.search_text && ep.search_text.length > 0) snippet = ep.search_text.substring(0, 150) + "...";
                    else snippet = "No transcript available.";
                }

                const paddingClass = isSearching ? "py-6" : "py-3";

                // Icon Logic
                let iconImg = 'premiumicon.png';
                if (ep.title.startsWith('Ep')) iconImg = 'cumtown.png';

                row.innerHTML = `
                    <div class="flex items-center px-4 ${paddingClass} cursor-pointer hover:bg-gray-50 dark:hover:bg-darkRowHover" onclick="toggleDetails(${uid}, ${isSearching})">
                        
                        <!-- Play/Index Column -->
                        <div class="w-12 flex justify-center items-center flex-shrink-0 mr-4 play-btn-group" onclick="event.stopPropagation(); playEpisode(${uid}, 0)">
                            <span class="index-num text-gray-500 font-medium text-sm">${index + 1}</span>
                            <i class="fas fa-play text-white play-icon"></i>
                            <i class="fas fa-pause text-white pause-icon"></i>
                            <div class="visualizer hidden">
                                <div class="bar"></div>
                                <div class="bar"></div>
                                <div class="bar"></div>
                                <div class="bar"></div>
                            </div>
                        </div>

                        <!-- Icon Column -->
                        <div class="w-12 h-12 flex-shrink-0 mr-4">
                            <img src="${iconImg}" class="w-full h-full object-cover rounded">
                        </div>

                        <!-- Title/Snippet Column -->
                        <div class="flex-1 min-w-0 pr-4">
                            <div class="flex items-baseline mb-1">
                                <span class="text-gray-900 dark:text-white font-bold text-base mr-2 ${currentPlayingUid === uid ? 'text-orange-500 dark:text-orange-400' : ''}">${displayTitle}</span>
                            </div>
                            <div class="leading-relaxed text-gray-500 dark:text-gray-400 text-sm ${isSearching ? '' : 'truncate'}">
                                ${snippet}
                            </div>
                        </div>

                        <!-- Date Column -->
                        <div class="w-24 text-right font-bold text-gray-600 dark:text-gray-400 text-sm whitespace-nowrap flex-shrink-0">
                            ${displayDate}
                        </div>
                    </div>
                    
                    <div id="details-${uid}" class="${openDropdownUids.has(uid) ? '' : 'hidden'} bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-600 px-4 py-4 ml-16 mr-4 rounded-b-lg mb-4 relative">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-gray-700 dark:text-gray-300">Transcript Matches:</h4>
                            <a href="transcript.html?id=${ep.id}&search=${encodeURIComponent(searchTerms.join(' '))}" target="_blank" class="text-blue-500 hover:text-blue-700" title="Open Full Transcript">
                                <i class="fas fa-external-link-alt text-lg"></i>
                            </a>
                        </div>
                        <div id="matches-${uid}" class="space-y-2 text-sm text-gray-600 dark:text-gray-400 max-h-96 overflow-y-auto pr-2"></div>
                    </div>
                `;
                list.appendChild(row);
                if (isSearching) populateDetails(ep, searchTerms, uid);
            });
        }

        function toggleDetails(uid, isSearching) {
            const drawer = document.getElementById(`details-${uid}`);
            if (drawer.classList.contains('hidden')) {
                drawer.classList.remove('hidden');
                openDropdownUids.add(uid);
            } else {
                drawer.classList.add('hidden');
                openDropdownUids.delete(uid);
            }
        }

        function populateDetails(ep, searchTerms, uid) {
            const container = document.getElementById(`matches-${uid}`);
            if (!ep.segments || ep.segments.length === 0) { container.innerHTML = "No timestamped segments."; return; }
            const matches = ep.segments.filter(seg => {
                const txt = seg.t.toLowerCase();
                return searchTerms.some(term => txt.includes(term));
            });
            if (matches.length === 0) { container.innerHTML = "Terms found in full text but not aligned."; return; }
            let html = "";
            matches.forEach(seg => {
                let text = seg.t;
                searchTerms.forEach(term => {
                    const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    text = text.replace(regex, '<span class="rainbow-glow">$1</span>');
                });
                html += `
                    <div class="flex items-start hover:bg-gray-200 dark:hover:bg-gray-700 p-2 rounded cursor-pointer" onclick="playEpisode(${uid}, ${seg.s})">
                        <span class="text-blue-600 dark:text-blue-400 font-mono text-xs mr-3 mt-1 flex-shrink-0">${formatTimestamp(seg.s)}</span>
                        <span class="leading-snug">${text}</span>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function handleInputSearch() { runFilters(); }

        // --- View Logic ---
        function setView(viewName) {
            currentView = viewName;
            const epNav = document.getElementById('nav-episodes');
            const mkNav = document.getElementById('nav-marketplace');
            const epList = document.getElementById('episodeList');
            const mkList = document.getElementById('marketplaceList');
            const filterBar = document.getElementById('filterBar').parentElement; // The sticky header for filters

            // Reset Styles
            const activeClass = "bg-orange-100 dark:bg-orange-900/50 text-orange-800 dark:text-orange-300 font-bold border-orange-500".split(" ");
            const inactiveClass = "hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-400 border-transparent".split(" ");

            if (viewName === 'episodes') {
                // Style Episodes Active
                epNav.classList.remove(...inactiveClass);
                epNav.classList.add(...activeClass);

                // Style Marketplace Inactive
                mkNav.classList.remove(...activeClass);
                mkNav.classList.add(...inactiveClass);

                // Show Episodes
                epList.classList.remove('hidden');
                mkList.classList.add('hidden');
                filterBar.classList.remove('hidden');

                // Ensure filters run
                runFilters();
            } else {
                // Style Marketplace Active
                mkNav.classList.remove(...inactiveClass);
                mkNav.classList.add(...activeClass);

                // Style Episodes Inactive
                epNav.classList.remove(...activeClass);
                epNav.classList.add(...inactiveClass);

                // Show Marketplace
                mkList.classList.remove('hidden');
                epList.classList.add('hidden');
                filterBar.classList.add('hidden');

                renderMarketplace();
            }
        }

        function renderMarketplace() {
            const list = document.getElementById('marketplaceList');
            list.innerHTML = "";

            const items = [
                {
                    title: "Depop",
                    desc: "100% Cotton T-Shirts made in Los Angeles",
                    link: "https://www.depop.com/fivestarsilver",
                    icon: "fas fa-tshirt"
                },
                {
                    title: "DVD Collection",
                    desc: "Curated selection of rare films",
                    link: "#",
                    icon: "fas fa-compact-disc"
                },
                {
                    title: "Stickers",
                    desc: "High quality vinyl stickers",
                    link: "#",
                    icon: "fas fa-sticky-note"
                },
                {
                    title: "Posters",
                    desc: "Limited edition prints",
                    link: "#",
                    icon: "fas fa-image"
                },
                {
                    title: "Digital Downloads",
                    desc: "Exclusive audio content",
                    link: "#",
                    icon: "fas fa-file-audio"
                }
            ];

            items.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = "border-b border-gray-100 dark:border-gray-700 transition relative group hover:bg-gray-50 dark:hover:bg-darkRowHover cursor-pointer";
                row.onclick = () => window.open(item.link, '_blank');

                row.innerHTML = `
                    <div class="flex items-center px-4 py-3">
                        <!-- Index Column -->
                        <div class="w-12 flex justify-center items-center flex-shrink-0 mr-4">
                            <span class="text-gray-500 font-medium text-sm">${index + 1}</span>
                        </div>

                        <!-- Icon Column -->
                        <div class="w-12 h-12 flex-shrink-0 mr-4 bg-gray-200 dark:bg-gray-700 rounded flex items-center justify-center">
                            <i class="${item.icon} text-gray-500 dark:text-gray-400 text-xl"></i>
                        </div>

                        <!-- Title/Desc Column -->
                        <div class="flex-1 min-w-0 pr-4">
                            <div class="flex items-baseline mb-1">
                                <span class="text-gray-900 dark:text-white font-bold text-base mr-2">${item.title}</span>
                                ${item.title === 'Depop' ? '<i class="fas fa-tag text-green-500 text-sm"></i>' : ''}
                            </div>
                            <div class="leading-relaxed text-gray-500 dark:text-gray-400 text-sm truncate">
                                ${item.desc}
                            </div>
                        </div>
                        
                        <!-- Arrow -->
                        <div class="w-12 flex justify-center items-center text-gray-400">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                `;
                list.appendChild(row);
            });
        }

        // --- Audio Logic ---

        function toggleShuffle() {
            isShuffleOn = !isShuffleOn;
            const btn = document.getElementById('shuffleBtn');
            if (isShuffleOn) {
                btn.classList.remove('text-gray-400');
                btn.classList.add('text-orange-500');
            } else {
                btn.classList.remove('text-orange-500');
                btn.classList.add('text-gray-400');
            }
        }

        function playHeaderBtn() {
            if (!currentFilteredData || currentFilteredData.length === 0) return;

            if (isShuffleOn) {
                const randomEp = currentFilteredData[Math.floor(Math.random() * currentFilteredData.length)];
                playEpisode(randomEp._uid !== undefined ? randomEp._uid : window.db.indexOf(randomEp));
            } else {
                const firstEp = currentFilteredData[0];
                playEpisode(firstEp._uid !== undefined ? firstEp._uid : window.db.indexOf(firstEp));
            }
        }

        function playEpisode(uid, startTime = 0) {
            const ep = window.db[uid];
            if (!ep || !ep.audio) { alert("Audio link not found."); return; }

            if (currentPlayingUid === uid) {
                if (startTime > 0) {
                    player.currentTime = startTime;
                    if (player.paused) player.play();
                } else {
                    togglePlay();
                }
                return;
            }

            currentPlayingUid = uid;

            // Update Footer Info
            document.getElementById('playerTitle').innerText = ep.title;
            document.getElementById('playerDate').innerText = formatDateWithSlashes(ep.date || "");
            document.getElementById('playerImg').src = ep.title.startsWith('Ep') ? 'cumtown.png' : 'premiumicon.png';
            document.getElementById('playerImg').classList.remove('hidden');
            document.getElementById('playerPlaceholder').classList.add('hidden');

            player.src = ep.audio;
            player.currentTime = startTime;
            player.play();

            updateOverlayContent(ep);
            runFilters();
        }

        function togglePlay() {
            if (currentPlayingUid === null) return;
            if (player.paused) player.play();
            else player.pause();
            runFilters();
        }

        function playNext() {
            if (!window.db) return;

            if (isShuffleOn && currentFilteredData.length > 0) {
                const randomEp = currentFilteredData[Math.floor(Math.random() * currentFilteredData.length)];
                playEpisode(randomEp._uid !== undefined ? randomEp._uid : window.db.indexOf(randomEp));
            } else if (currentPlayingUid !== null && currentPlayingUid < window.db.length - 1) {
                playEpisode(currentPlayingUid + 1);
            }
        }

        function playPrev() {
            if (!window.db || currentPlayingUid === null) return;
            if (currentPlayingUid > 0) {
                playEpisode(currentPlayingUid - 1);
            }
        }

        player.addEventListener('ended', () => { playNext(); });

        // --- Overlay Logic ---
        function toggleOverlay() {
            const overlay = document.getElementById('micOverlay');
            if (overlay.classList.contains('hidden')) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function updateOverlayContent(ep) {
            document.getElementById('overlayTitle').innerText = ep.title;
            const textContainer = document.getElementById('overlayText');
            if (ep.segments && ep.segments.length > 0) {
                textContainer.innerHTML = ep.segments.map(s => `<p>${s.t}</p>`).join('');
            } else {
                textContainer.innerText = ep.search_text || "No transcript available.";
            }
        }

        function toggleCompose() {
            const modal = document.getElementById('composeModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('translate-y-full'), 10);
            } else {
                modal.classList.add('translate-y-full');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        // Initialize
        window.onload = function () {
            // Wait for data parts to load
            setTimeout(() => {
                if (window.db) runFilters();
                else console.error("Database not loaded");
            }, 500);
        };
    </script>
</body>

</html>